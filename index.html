<html lang="en">
  <!-- February 2022 -->
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Facade Risk Levels</title>
    <link
      rel="icon"
      href="https://raw.githubusercontent.com/cathycodes/facaderisk/main/iconlogo.png"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/opencagedata/leaflet-opencage-search@d4cbd36122efc8d17152b4177ed0e12165305441/dist/css/L.Control.OpenCageData.Search.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Caveat&family=Montserrat:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        width: 100%;
        height: 100vh;
        padding: 0;
        margin: 0;
        font-family: "Montserrat";
        box-sizing: border-box;
        overflow-y: hidden;
        background-color: rgb(235, 235, 235);
      }
      .cTooltip {
        color: #002878;
        border: 1px solid rgb(56, 56, 56);
        border-radius: 5px;
        padding: 10px;
        font-weight: bolder;
      }
      .bAboutMapBtn {
        color: black;
        font-weight: 500;
        font-size: 1.2em;
      }
      .aboutText {
        border: 3px solid rgb(90, 90, 90);
        background-color: #f3f4f9;
        font-size: 1.4em;
        max-height: 600px;
        margin-top: 70px;
        font-weight: 600;
      }
      .info.legend {
        width: 260px;
        height: 250px;
        opacity: 1;
        background-color: #d7dce0;
        margin: 40% 100px 20px 5px;
        padding: 10px;
        border: solid 3px rgb(63, 63, 63);
        border-radius: 3%;
        color: rgb(46, 45, 45);
      }
      .devsquad a:link,
      .devsquad a:visited,
      .devsquad a:active {
        text-decoration: none;
        color: white;
      }
      .bDownloadData * {
        text-decoration: none;
        color: black;
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar"
      style="
        background: #002878 !important;
        color: white;
        border: 1px solid rgb(235, 233, 233);
      "
    >
      <h1 class="display-5 text-uppercase mx-auto xxfw-bold">
        Facade Risk Levels
      </h1>
      <a
        class="navbar-brand"
        href="https://www1.nyc.gov/site/buildings/index.page"
        target="_blank"
        ><img
          src="https://raw.githubusercontent.com/cathycodes/facaderisk/main/dob_logo_white_transparent.png"
          width="80"
          height="auto"
          class="d-inline-block align-top"
          alt=""
      /></a>
    </nav>
    <div class="container-fluid" style="overflow-y: hidden; padding: 0">
      <div
        class="container-fluid"
        id="map"
        style="
          height: 89%;
          width: 100%;
          border: 1px solid rgb(158, 155, 154);
          pointer-events: all;
        "
      ></div>
      <div
        style="
          background-color: black;
          font-weight: 600;
          color: white;
          height: 6%; /*50px*/
        "
      >
        <div style="margin: 10px" class="float-start devsquad small">
          <a
            href="https://www1.nyc.gov/site/buildings/dob/analytics-reports.page"
            target="_blank"
            >DOB Analytics</a
          >
        </div>
        <div style="margin: 10px" class="float-end devsquad small">
          <a href="https://www1.nyc.gov/home/terms-of-use.page" target="_blank"
            >Terms of Use</a
          >
        </div>
      </div>
    </div>
    <div
      class="offcanvas offcanvas-start aboutText"
      tabindex="-1"
      id="offcanvasLeft"
      aria-labelledby="offcanvasLeftLabel"
    >
      <div class="offcanvas-header">
        <button
          type="button"
          class="btn-close text-reset"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        This map displays a risk probability rating for all NYC buildings in the
        <a
          href="https://www1.nyc.gov/site/buildings/safety/facade-local-law.page"
          target="_blank"
          >Façade Inspection Safety Program (FISP)</a
        >
        Local Law 11 universe. Buildings with a higher risk probability value
        are more likely to exhibit high-risk outcomes such as specific
        façade-related violations, unsafe conditions, or façade-related
        accidents. Risk scores may be used to better inform proactive
        enforcement actions.
      </div>
    </div>
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""
    ></script>
    <script src="https://cdn.jsdelivr.net/gh/opencagedata/leaflet-opencage-search@d4cbd36122efc8d17152b4177ed0e12165305441/dist/js/L.Control.OpenCageSearch.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/d3-fetch@3"></script> -->
    <script>
      const map = L.map("map", { preferCanvas: true }).setView(
        [40.714299, -74.0080041],
        15
      );
      let options = {
        key: "9277c3027dc546989ea28d048ffa9ee7",
        limit: 10,
        proximity: "40.791384, -73.883770",
        placeholder: "e.g. 280 Broadway NYC",
        errorMessage: "Nothing found.",
        showResultIcons: false,
        collapsed: true,
        expand: "click",
        addResultToMap: true,
      };
      var control = L.Control.openCageSearch(options).addTo(map);
      control.markGeocode = function (result) {
        // JvdB single instance: singleton
        L.Control.OpenCageSearch.instance = this;
        if (result.bounds) {
          this._map.fitBounds(result.bounds);
        } else {
          this._map.panTo(result.center);
        }
        if (this._geocodeMarker) {
          this._map.removeLayer(this._geocodeMarker);
        }
        // JvdB add button in Popup to remove Marker
        let popupDiv = document.createElement("div");
        let locationText = document.createElement("h5");
        locationText.innerText = result.name;
        let closeMarkerDiv = document.createElement("div");
        closeMarkerDiv.style.textAlign = "center";
        let closeMarkerDivButton = document.createElement("button");
        closeMarkerDivButton.innerText = "Remove";
        closeMarkerDivButton.setAttribute("title", "Remove marker from map");
        closeMarkerDivButton.setAttribute("type", "button");
        closeMarkerDivButton.classList.add("btn", "removemarkerbutton");
        closeMarkerDivButton.addEventListener("click", function (e) {
          L.Control.OpenCageSearch.instance._map.removeLayer(
            L.Control.OpenCageSearch.instance._geocodeMarker
          );
        });
        closeMarkerDiv.appendChild(closeMarkerDivButton);
        popupDiv.appendChild(locationText);
        popupDiv.appendChild(closeMarkerDiv);
        this._geocodeMarker = new L.Marker(result.center)
          .bindPopup(popupDiv)
          .addTo(this._map)
          .openPopup();
        return this;
      };
      L.tileLayer(
        "https://api.mapbox.com/styles/v1/mapbox/dark-v10/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYm1hbmNlbGwiLCJhIjoiY2oxZ24yd3E2MDAzdDJ3cG1jenB2dTl3cSJ9.38jhDPw4NnOpKK2mMmF_xQ",
        {
          attribution:
            '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          maxZoom: 18,
          opacity: 0.95,
          zIndex: 0,
          zoomOffset: -1,
          tileSize: 512,
          unloadInvisibleTiles: true,
          updateWhenZooming: false,
          updateWhenIdle: true,
          reuseTiles: true,
        }
      ).addTo(map);
      var vProbability = [
        { vLow: 0.0, vHi: 0.062484, vColor: "rgb(0, 162, 232)" },
        { vLow: 0.062485, vHi: 0.191381, vColor: "rgb(153, 194, 188)" },
        { vLow: 0.191382, vHi: 0.354539, vColor: "rgb(204, 222, 162)" },
        { vLow: 0.35454, vHi: 0.534229, vColor: "rgb(255, 242, 0)" },
        { vLow: 0.53423, vHi: 0.723084, vColor: "rgb(251, 194, 105)" },
        { vLow: 0.723085, vHi: 0.896842, vColor: "rgb(255,128,0)" },
        { vLow: 0.896843, vHi: 1.0, vColor: "rgb(237, 28, 36)" },
      ];
      d3.json(
        "https://raw.githubusercontent.com/NYCDOB/FacadeRisk/main/FacadeRisk_Unproj.json",
        function (data) {
          let probColor = function (a) {
            for (let x of vProbability) {
              if (a <= x.vHi) {
                return x.vColor;
              }
            }
          };
          L.geoJson(data, {
            preferCanvas: true,
            onEachFeature: function (feature, layer) {
              let vTooltip = `<h6>Probability: ${feature.properties.PredProb}</h6><h6>Address:&nbsp;&nbsp;&nbsp;&nbsp;${feature.properties.Address} (${feature.properties.Borough})</h6>`;
              layer.bindTooltip(vTooltip, { className: "cTooltip" });
            },
            style: function (feature) {
              return {
                fillColor: probColor(feature.properties.PredProb),
                weight: 1,
                opacity: 0.5,
                color: "white",
                fillOpacity: 0.7,
              };
            },
          }).addTo(map);

          let infoDiv = L.control({ position: "topleft" });
          infoDiv.onAdd = function (map) {
            let div = L.DomUtil.create("div", "bAboutMapDiv");
            div.innerHTML = `<button class="btn btn-light bAboutMapBtn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasLeft" aria-controls="offcanvasLeft">About Map</button>`;
            return div;
          };
          infoDiv.addTo(map);
          let legend = L.control({ position: "bottomright" });
          //legend.onAdd = function (map) {
          legend.onAdd = function () {
            let div = L.DomUtil.create("div", "info legend");
            div.innerHTML = `<h5 style="text-align:center;font-weight:700;">Risk Probability</h5><br>`;
            for (var i = 0; i < vProbability.length; i++) {
              div.innerHTML += `<div class="row" style="font-weight:700;font-size:1.2em;">            
									<div class="col-3" style="background-color:${
                    vProbability[i].vColor
                  };margin:0 0 0 10px;width:15px;height:25px;"></div>
									<div class="col-9"><span style="line-height:25px;">${vProbability[
                    i
                  ].vLow.toFixed(
                    6
                  )}&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;${vProbability[
                i
              ].vHi.toFixed(6)}</span></div>
									</div>`;
            }
            return div;
          };
          legend.addTo(map);
          let downloadDiv = L.control({ position: "topleft" });
          downloadDiv.onAdd = function () {
            let div = L.DomUtil.create("div", "bDownloadData");
            data;
            div.innerHTML = `<a class="text-dark btn btn-light" target="_blank" title="Download to FacadeRiskExport.csv">Export data</a>`;
            return div;
          };
          downloadDiv.addTo(map);
          let bdlBtn = document.querySelector(".bDownloadData");
          bdlBtn.addEventListener("click", function (e) {
            e.preventDefault;
            event.stopImmediatePropagation();
            let dataArray = [];
            dataArray.push(
              "BIN,Address,Borough,Risk_Probability,Community_District"
            );
            for (let _q = 0, _str = ""; _q < data.features.length; _q++) {
              _str = `${data.features[_q].properties.BIN_1},${
                data.features[_q].properties.Address
              },${data.features[_q].properties.Borough},${
                data.features[_q].properties.PredProb
              },${
                data.features[_q].properties.Community_ == "nan"
                  ? ""
                  : data.features[_q].properties.Community_
              }`;
              dataArray.push(_str); //Object.values(data.features[_q].properties).toString()
            }
            let file = new Blob([dataArray.join("\n")]);
            savebtn = document.createElement("a");
            savebtn.style.display = "none";
            savebtn.className = "saveit";
            savebtn.style.visibility = "hidden";
            document.body.prepend(savebtn);
            let _theLink = document.querySelector("a.saveit");
            _theLink.href = URL.createObjectURL(file);
            _theLink.download = "FacadeRiskExport.csv";
            _theLink.click();
            savebtn.remove();
          });
        }
      );
    </script>
  </body>
</html>
